@using ElectionShield.ViewModels
@model HeatMapViewModel
@{
    ViewData["Title"] = "Incident Heat Map";
    Layout = "_AdminLayout";
    ViewBag.ActiveSection = Model.ActiveSection;
}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="fas fa-map-marked-alt text-primary me-2"></i>
        Incident Heat Map
    </h1>
    <div class="text-muted">
        Real-time incident visualization
    </div>
</div>

<!-- Filters Card -->
<div class="card mb-4">
    <div class="card-header bg-white">
        <h5 class="card-title mb-0">
            <i class="fas fa-filter me-2"></i>Filter Incidents
        </h5>
    </div>
    <div class="card-body">
        <form id="filterForm" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Category</label>
                <select name="category" class="form-select" id="categoryFilter">
                    <option value="">All Categories</option>
                    @foreach (var category in Model.Categories)
                    {
                        <option value="@category">@category</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Status</label>
                <select name="status" class="form-select" id="statusFilter">
                    <option value="">All Status</option>
                    @foreach (var status in Model.Statuses)
                    {
                        <option value="@((int)status)">@status</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Priority</label>
                <select name="priority" class="form-select" id="priorityFilter">
                    <option value="">All Priorities</option>
                    @foreach (var priority in Model.Priorities)
                    {
                        <option value="@((int)priority)">@priority</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Start Date</label>
                <input type="date" name="startDate" class="form-control"
                       value="@Model.DefaultStartDate.ToString("yyyy-MM-dd")" id="startDateFilter">
            </div>
            <div class="col-md-2">
                <label class="form-label">End Date</label>
                <input type="date" name="endDate" class="form-control"
                       value="@Model.DefaultEndDate.ToString("yyyy-MM-dd")" id="endDateFilter">
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-primary w-100" id="applyFilters">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <!-- Map Container -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-map me-2"></i>Incident Heat Map
                </h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-primary active" data-map-type="heatmap">
                        <i class="fas fa-fire"></i> Heat Map
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-map-type="clusters">
                        <i class="fas fa-layer-group"></i> Clusters
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" data-map-type="points">
                        <i class="fas fa-map-marker-alt"></i> Points
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="heatMap" style="height: 600px; width: 100%;"></div>
            </div>
        </div>
    </div>

    <!-- Statistics Sidebar -->
    <div class="col-lg-4">
        <!-- Summary Stats -->
        <div class="card mb-4">
            @* <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Map Summary
                </h5>
            </div>
            <div class="card-body">
                <div id="mapStats">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-sync fa-spin fa-2x mb-2"></i>
                        <p>Loading statistics...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Incident Hotspots -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Incident Hotspots
                </h5>
            </div>
            <div class="card-body">
                <div id="hotspotsList">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-sync fa-spin mb-2"></i>
                        <p>Loading hotspots...</p>
                    </div>
                </div>
            </div>
        </div> *@

        <!-- Legend -->
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Map Legend
                </h5>
            </div>
            <div class="card-body">
                @* <div class="mb-2">
                    <div class="d-flex align-items-center mb-1">
                        <div class="legend-color heat-high me-2" style="width: 20px; height: 20px;"></div>
                        <small>High Intensity (Critical/High Priority)</small>
                    </div>
                    <div class="d-flex align-items-center mb-1">
                        <div class="legend-color heat-medium me-2" style="width: 20px; height: 20px;"></div>
                        <small>Medium Intensity (Medium Priority)</small>
                    </div>
                    <div class="d-flex align-items-center mb-1">
                        <div class="legend-color heat-low me-2" style="width: 20px; height: 20px;"></div>
                        <small>Low Intensity (Low Priority)</small>
                    </div>
                </div>
                <hr> *@
                <div class="mb-2">
                    <div class="d-flex align-items-center mb-1">
                        <i class="fas fa-circle text-success me-2"></i>
                        <small>Verified Reports</small>
                    </div>
                    <div class="d-flex align-items-center mb-1">
                        <i class="fas fa-circle text-warning me-2"></i>
                        <small>Pending Reports</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-circle text-danger me-2"></i>
                        <small>Rejected Reports</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Incident Details Modal -->
<div class="modal fade" id="incidentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Incident Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="incidentDetails">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-primary" id="viewReportBtn">
                    <i class="fas fa-external-link-alt me-1"></i>View Full Report
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
       
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.css" />
    <style>
        .legend-color {
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        .heat-high { background: linear-gradient(to right, #ff0000, #ff4400); }
        .heat-medium { background: linear-gradient(to right, #ff4400, #ff8800); }
        .heat-low { background: linear-gradient(to right, #ff8800, #ffcc00); }

        .hotspot-item {
            border-left: 4px solid #ffc107;
            transition: all 0.3s;
        }

        .hotspot-item:hover {
            background-color: #fff3cd;
            transform: translateX(5px);
        }

        .risk-high { border-left-color: #dc3545 !important; }
        .risk-medium { border-left-color: #fd7e14 !important; }
        .risk-low { border-left-color: #ffc107 !important; }

        #heatMap {
            border-radius: 0 0 0.375rem 0.375rem;
        }

        .cluster-marker {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            text-align: center;
            font-weight: bold;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
    </style>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
        $(document).ready(async function(){
            initMap();

            let mapPoints = await getIncidents();
            debugger;

            addReportMarkers(mapPoints);
        });

            function initMap() {
            map = L.map('heatMap').setView([20.5937, 78.9629], 5); // Center on India

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            // Create layer groups
            heatLayer = L.layerGroup().addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            clustersLayer = L.layerGroup().addTo(map);
        }

function getIncidents() {
    return $.ajax({
        url: "/Report/GetAllReports",
        type: "POST"
    });
}

function addReportMarkers(reports) {

    // Use a red marker icon
    var redIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var yellowIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var greenIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    debugger;
    reports.forEach(r => {
        debugger;
        if (r.latitude && r.longitude) {

            if(r.status === 2 || r.status === 4 || r.status === 6){
            L.marker([r.latitude, r.longitude], { icon: greenIcon })
                .addTo(map)
                .bindPopup(`
                    <b>${r.title}</b><br/>
                    ${r.location}<br/>
                    <span class="text-muted">${r.category}</span>
                    <a href = "/Report/Track?reportCode=${r.reportCode}">View Report</a>
                `);
            }
            if(r.status === 0 || r.status === 1){
                            L.marker([r.latitude, r.longitude], { icon: yellowIcon })
                .addTo(map)
                .bindPopup(`
                    <b>${r.title}</b><br/>
                    ${r.location}<br/>
                    <span class="text-muted">${r.category}</span>
                    <a href = "/Report/Track?reportCode=${r.reportCode}">View Report</a>
                `);
            }
            if(r.status === 3 || r.status === 7){
                L.marker([r.latitude, r.longitude], { icon: redIcon })
                .addTo(map)
                .bindPopup(`
                    <b>${r.title}</b><br/>
                    ${r.location}<br/>
                    <span class="text-muted">${r.category}</span>
                    <a href = "/Report/Track?reportCode=${r.reportCode}">View Report</a>
                `);
            }
        }
    });
}
</script>
