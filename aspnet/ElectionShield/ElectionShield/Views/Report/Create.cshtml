@model ElectionShield.ViewModels.CreateReportViewModel
@{
    ViewData["Title"] = "Report Election Incident / निर्वाचन घटनाको रिपोर्ट";
}

<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow border-0">
            <div class="card-header bg-primary text-white py-3">
                <h2 class="h4 mb-0">
                    <i class="fas fa-flag me-2"></i>
                    Report Election Incident / निर्वाचन घटनाको रिपोर्ट
                </h2>
                <p class="mb-0 opacity-75">
                    Help protect election integrity / निर्वाचन सुरक्षित राख्न सहयोग गर्नुहोस् — रिपोर्ट गोप्य रूपमा दिन सकिन्छ
                </p>
            </div>

            <div class="card-body p-4">
                <form asp-action="Create" method="post" enctype="multipart/form-data" id="reportForm">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>


                    <!-- TITLE + CATEGORY -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label asp-for="Title" class="form-label fw-semibold">
                                    Incident Title / घटना शीर्षक *
                                </label>
                                <input asp-for="Title" class="form-control form-control-lg"
                                       placeholder="Brief incident title / छोटो र वर्णनात्मक शीर्षक लेख्नुहोस्" />
                                <span asp-validation-for="Title" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label asp-for="Category" class="form-label fw-semibold">
                                    Incident Category / घटना प्रकार *
                                </label>
                                <select asp-for="Category" class="form-select form-select-lg">
                                    <option value="">Select Category / प्रकार छान्नुहोस्</option>
                                    <option value="Voter Intimidation">Voter Intimidation / मतदाता धम्क्याउने</option>
                                    <option value="Ballot Tampering">Ballot Tampering / मतपत्र हेरफेर</option>
                                    <option value="Polling Station Issues">Polling Station Issues / मतदान केन्द्र समस्या</option>
                                    <option value="Fraudulent Voting">Fraudulent Voting / जाली मतदान</option>
                                    <option value="Technical Glitches">Technical Glitches / प्राविधिक समस्या</option>
                                    <option value="Campaign Violations">Campaign Violations / चुनाव नियम उल्लङ्घन</option>
                                    <option value="Other">Other / अन्य</option>
                                </select>
                                <span asp-validation-for="Category" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>


                    <!-- DESCRIPTION -->
                    <div class="form-group mb-3">
                        <label asp-for="Description" class="form-label fw-semibold">
                            Detailed Description / घटना विवरण *
                        </label>
                        <textarea asp-for="Description" class="form-control" rows="5"
                                  placeholder="Describe what happened... / के भयो, कहाँ भयो, कसरी भयो विस्तृत रूपमा लेख्नुहोस्"></textarea>
                        <div class="form-text">
                            Be detailed as possible / सकेसम्म विस्तृत जानकारी लेख्नुहोस्
                        </div>
                        <span asp-validation-for="Description" class="text-danger small"></span>
                    </div>


                    <!-- LOCATION -->
                    <div class="form-group mb-3">
                        <label asp-for="Location" class="form-label fw-semibold">
                            Location Description / स्थान विवरण *
                        </label>
                        <input asp-for="Location" class="form-control"
                               placeholder="Street, landmark, station... / सडक, स्थान, चिन्ह वा क्षेत्र" id="locationInput" />
                        <span asp-validation-for="Location" class="text-danger small"></span>
                    </div>


                    <!-- LAT + LONG -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label asp-for="Latitude" class="form-label fw-semibold">
                                Latitude / अक्षांश *
                            </label>
                            <input asp-for="Latitude" class="form-control" id="latitude" readonly />
                            <span asp-validation-for="Latitude" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Longitude" class="form-label fw-semibold">
                                Longitude / देशान्तर *
                            </label>
                            <input asp-for="Longitude" class="form-control" id="longitude" readonly />
                            <span asp-validation-for="Longitude" class="text-danger small"></span>
                        </div>
                    </div>


                    <!-- MAP SELECT -->
                    <div class="form-group mb-4">
                        <label class="form-label fw-semibold">
                            Select Location on Map / नक्सामा स्थान छान्नुहोस् *
                        </label>
                        <div id="map" style="height: 300px; width: 100%; border-radius: 0.375rem; border: 1px solid #dee2e6;"></div>
                        <div class="form-text">
                            Click on the map to select location / नक्सामा क्लिक गरेर स्थान चिन्ह लगाउनुहोस्
                        </div>
                    </div>


                    <!-- UPLOAD -->
                    <div class="form-group mb-4">
                        <label class="form-label fw-semibold">
                            Upload Evidence (Upload गर्नुस्)
                        </label>

                        <div class="file-upload-area border rounded p-4 text-center">
                            <input type="file" asp-for="MediaFiles" class="form-control" multiple
                                   accept="image/*,video/*,.pdf,.doc,.docx,.txt" id="fileInput" required />

                            <div class="mt-2">
                                <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                <p class="text-muted mb-1">
                                    Drag & drop files or click to browse /
                                    फाइल तानेर राख्नुहोस् वा क्लिक गरेर छान्नुहोस्
                                </p>
                                <small class="text-muted">
                                    Max 10MB each / अधिकतम १०MB — Images, Videos, PDF, DOC, TXT
                                </small>
                            </div>
                        </div>

                        <div id="filePreview" class="mt-3"></div>
                    </div>


                    <!-- CONTACT -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="ReporterEmail" class="form-label fw-semibold">
                                    Email Address (Optional) / इमेल (ऐच्छिक)
                                </label>
                                <input asp-for="ReporterEmail" class="form-control"
                                       placeholder="example@gmail.com / इमेल राख्न चाहनुहुन्छ भने यहाँ लेख्नुहोस्" />
                                <span asp-validation-for="ReporterEmail" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="ReporterPhone" class="form-label fw-semibold">
                                    Phone Number (Optional) / फोन नम्बर (ऐच्छिक)
                                </label>
                                <input asp-for="ReporterPhone" class="form-control"
                                       placeholder="+98******** / फोन नम्बर राख्न चाहनुहुन्छ भने" />
                                <span asp-validation-for="ReporterPhone" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>


                    <!-- ANONYMOUS -->
                    <div class="form-check mb-4">
                        <input asp-for="IsAnonymous" class="form-check-input" checked />
                        <label asp-for="IsAnonymous" class="form-check-label fw-semibold">
                            Submit anonymously / गुमनाम रूपमा पेश गर्नुहोस् (सिफारिस)
                        </label>
                        <div class="form-text">
                            Your personal info will not be stored / तपाईंको व्यक्तिगत जानकारी सुरक्षित रहनेछ
                        </div>
                    </div>

                    <input type="text" class="uid" name="createdBy" hidden />


                    <!-- CONFIRMATION -->
                    <div class="form-check mb-4">
                        <input asp-for="Confirmation" class="form-check-input" required />
                        <label asp-for="Confirmation" class="form-check-label fw-semibold">
                            I confirm this report is accurate /
                            यो रिपोर्ट सही छ भनेर म पुष्टि गर्दछु
                        </label>
                        <span asp-validation-for="Confirmation" class="text-danger small"></span>
                    </div>


                    <!-- BUTTONS -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="fas fa-paper-plane me-2"></i>
                            Submit Report / रिपोर्ट पेश गर्नुहोस्
                        </button>

                        <a asp-action="Track" class="btn btn-outline-secondary btn-lg px-5">
                            <i class="fas fa-search me-2"></i>
                            Track Report / रिपोर्ट ट्र्याक गर्नुहोस्
                        </a>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>


    <script>

$(document).ready(async function () {

    if(!localStorage.getItem("userId")){
        alert("Log in to report Incident");
        window.location.href = "/Home/Index";
    }
    else{
        $(".uid").val(localStorage.getItem("userId"));
    }

    let latLong = await getIncidents();
    addReportMarkers(latLong);
    getLocation();

    function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(success, error);
  } else {
    console.error("Location access denied");
  }
}

function success(position) {
  @* x.innerHTML = "Latitude: " + position.coords.latitude +
  "<br>Longitude: " + position.coords.longitude; *@

    $("#latitude").val(position.coords.latitude);
    $("#longitude").val(position.coords.longitude);
}

function error() {
  console.log("Can't detect location");
}
    debugger;
});

function getIncidents() {
    return $.ajax({
        url: "/Report/GetAllReports",
        type: "POST"
    });
}

function addReportMarkers(reports) {

    // Use a red marker icon
    var redIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

        var yellowIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var greenIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    reports.forEach(r => {
        debugger;
        if (r.latitude && r.longitude) {

            if(r.status === 2){
            L.marker([r.latitude, r.longitude], { icon: greenIcon })
                .addTo(map)
                .bindPopup(`
                    <b>${r.title}</b><br/>
                    ${r.location}<br/>
                    <span class="text-muted">${r.category}</span>
                    <a href = "/Report/Track?reportCode=${r.reportCode}">View Report</a>
                `);
            }
        }
    });
}
        // Initialize map
        var map = L.map('map').setView([28.175655, 83.965759], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        var marker;
        var latitudeInput = document.getElementById('latitude');
        var longitudeInput = document.getElementById('longitude');

        latitudeInput.value = '28.175655';
        longitudeInput.value = '83.965759';

        map.on('click', function (e) {
            if (marker) {
                map.removeLayer(marker);
            }

            marker = L.marker(e.latlng).addTo(map);
            latitudeInput.value = e.latlng.lat.toFixed(6);
            longitudeInput.value = e.latlng.lng.toFixed(6);

            // Reverse geocoding to get address
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`)
                .then(response => response.json())
                .then(data => {
                    if (data.display_name) {
                        document.getElementById('locationInput').value = data.display_name;
                    }
                })
                .catch(error => console.error('Error:', error));
        });

        // Get user's current location
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;

                    map.setView([lat, lng], 15);

                    if (!marker) {
                        marker = L.marker([lat, lng]).addTo(map);
                    } else {
                        marker.setLatLng([lat, lng]);
                    }

                    latitudeInput.value = lat.toFixed(6);
                    longitudeInput.value = lng.toFixed(6);

                    // Get address for current location
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.display_name) {
                                document.getElementById('locationInput').value = data.display_name;
                            }
                        });
                }, function (error) {
                    console.log('Geolocation error:', error);
                });
            }
        }

        // Add current location button
        L.control.locate({
            position: 'topright',
            strings: {
                title: "Show my location"
            }
        }).addTo(map);

        // File upload preview
        document.getElementById('fileInput').addEventListener('change', function (e) {
            const preview = document.getElementById('filePreview');
            preview.innerHTML = '';

            Array.from(e.target.files).forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'alert alert-info d-flex justify-content-between align-items-center';

                let fileTypeIcon = 'fas fa-file';
                if (file.type.startsWith('image/')) fileTypeIcon = 'fas fa-image';
                else if (file.type.startsWith('video/')) fileTypeIcon = 'fas fa-video';
                else if (file.type === 'application/pdf') fileTypeIcon = 'fas fa-file-pdf';

                fileItem.innerHTML = `
                            <div>
                                <i class="${fileTypeIcon} me-2"></i>
                                ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)
                            </div>
                            <div class="text-success">
                                <i class="fas fa-check"></i> Ready
                            </div>
                        `;

                preview.appendChild(fileItem);
            });
        });

        // Get current location on page load
        getCurrentLocation();
    </script>

    <style>
        .file-upload-area {
            border: 2px dashed #dee2e6;
            transition: border-color 0.3s ease;
            background: #f8f9fa;
        }

            .file-upload-area:hover {
                border-color: #0d6efd;
                background: #e7f1ff;
            }

            .file-upload-area.dragover {
                border-color: #0d6efd;
                background: #e7f1ff;
            }

        .card {
            border: none;
            border-radius: 1rem;
        }

        .card-header {
            border-radius: 1rem 1rem 0 0 !important;
        }
    </style>
}